<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Portfolio Manager (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #60a5fa; background: rgba(31, 41, 55, 0.5); }
        .tab-inactive { color: #9ca3af; }
        .tab-inactive:hover { color: #e5e7eb; background: rgba(31, 41, 55, 0.3); }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 text-center space-y-6">
            <div class="w-20 h-20 bg-gray-700 rounded-full flex items-center justify-center mx-auto text-blue-400 text-4xl mb-4">
                <i class="fa-solid fa-cloud"></i>
            </div>
            <h1 class="text-2xl font-bold text-white">Gemini Portfolio Manager</h1>
            <p class="text-gray-400">Googleアカウントでログインして、<br>どの端末からでもデータを同期します。</p>
            
            <button id="google-login-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-colors">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                Googleでログイン
            </button>
            <p id="login-status" class="text-xs text-gray-500 min-h-[1rem]"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-6 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-layer-group text-blue-500 text-xl"></i>
            <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                Gemini Portfolio Manager
            </h1>
        </div>
        
        <!-- User Profile & Data Controls -->
        <div class="flex items-center gap-4">
            <div id="sync-status" class="text-xs text-gray-500 flex items-center gap-1">
                <i class="fa-solid fa-check"></i> Synced
            </div>
            
            <div class="h-6 w-px bg-gray-700"></div>

            <div class="flex items-center gap-3">
                <img id="user-photo" src="" class="w-8 h-8 rounded-full border border-gray-600 hidden">
                <button onclick="logout()" class="text-xs text-gray-400 hover:text-white transition-colors" title="ログアウト">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-80 bg-gray-850 border-r border-gray-700 flex flex-col shrink-0 z-10">
            <!-- Tab Switcher -->
            <div class="flex border-b border-gray-700 bg-gray-800">
                <button onclick="switchTab('prompt')" id="tab-prompt" class="flex-1 py-3 text-xs md:text-sm font-bold transition-colors tab-active">
                    <i class="fa-solid fa-code mr-1"></i> <span class="hidden sm:inline">Prompts</span>
                </button>
                <button onclick="switchTab('portfolio')" id="tab-portfolio" class="flex-1 py-3 text-xs md:text-sm font-bold transition-colors tab-inactive">
                    <i class="fa-solid fa-briefcase mr-1"></i> <span class="hidden sm:inline">Portfolios</span>
                </button>
                <button onclick="switchTab('links')" id="tab-links" class="flex-1 py-3 text-xs md:text-sm font-bold transition-colors tab-inactive">
                    <i class="fa-solid fa-link mr-1"></i> <span class="hidden sm:inline">Links</span>
                </button>
            </div>

            <!-- Action Button & List Container -->
            <div id="sidebar-content" class="flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-gray-700 shrink-0">
                    <button onclick="createNew()" id="createBtn" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg transition-colors text-sm font-bold shadow-lg shadow-blue-900/20">
                        <i class="fa-solid fa-plus"></i> 新規作成
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1" id="itemList"></div>
            </div>
            
            <!-- Empty state for Links tab sidebar -->
            <div id="sidebar-links-msg" class="hidden flex-1 flex items-center justify-center text-gray-600 text-xs p-4 text-center">
                リンク集はメイン画面で<br>直接編集できます
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-900 relative w-full overflow-hidden">
            
            <!-- Editor Header -->
            <div class="bg-gray-800/50 p-4 border-b border-gray-700 flex items-center justify-between backdrop-blur-sm shrink-0">
                <div class="flex-1 mr-4">
                    <input type="text" id="inputTitle" class="bg-transparent border-none text-xl font-bold text-white focus:ring-0 w-full placeholder-gray-600" placeholder="タイトル...">
                    <div class="text-xs text-gray-500 mt-1" id="lastUpdated">Updated: -</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveCurrentItem()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">
                        <i class="fa-regular fa-floppy-disk mr-1"></i> <span class="hidden sm:inline">保存</span>
                    </button>
                    <button onclick="deleteCurrentItem()" id="headerDeleteBtn" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-2 rounded-lg text-sm border border-red-900">
                        <i class="fa-regular fa-trash-can"></i>
                    </button>
                </div>
            </div>

            <!-- Content Area Switcher -->
            <div class="flex-1 relative overflow-hidden">
                <!-- 1. Prompt Editor View -->
                <div id="view-prompt" class="absolute inset-0 flex flex-col hidden">
                    <div class="flex justify-end p-2 bg-gray-800/30">
                        <button onclick="copyContent()" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded">
                            <i class="fa-regular fa-copy mr-1"></i> コピー
                        </button>
                    </div>
                    <textarea id="inputContent" class="flex-1 w-full bg-gray-900 text-gray-300 p-6 resize-none focus:outline-none font-mono text-sm leading-relaxed" placeholder="ここにプロンプトを入力..."></textarea>
                </div>

                <!-- 2. Portfolio View -->
                <div id="view-portfolio" class="absolute inset-0 flex flex-col hidden overflow-hidden">
                    <div id="portfolio-importer" class="hidden absolute inset-0 z-20 bg-gray-900 p-8 flex flex-col items-center justify-center">
                        <div class="max-w-2xl w-full space-y-4 text-center">
                            <h3 class="text-xl font-bold text-white">Geminiの分析結果を取り込む</h3>
                            <textarea id="importText" class="w-full h-48 bg-gray-800 border border-gray-700 rounded-lg p-4 text-sm font-mono focus:border-emerald-500 focus:ring-1 outline-none" placeholder="| 順位 | コード | ..."></textarea>
                            <button onclick="importPortfolio()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold">解析して登録</button>
                            <button onclick="hideImportModal()" class="text-gray-500 text-xs hover:text-white mt-2">キャンセル</button>
                        </div>
                    </div>
                    <div id="portfolio-dashboard" class="flex-1 flex flex-col h-full overflow-hidden">
                        <div class="bg-gray-800 border-b border-gray-700 p-4 flex gap-6 text-sm shrink-0">
                            <div><span class="text-gray-500 block text-xs uppercase">投資総額</span><span class="font-bold text-lg" id="total-investment">¥0</span></div>
                            <div><span class="text-gray-500 block text-xs uppercase">現在評価額</span><span class="font-bold text-lg" id="total-value">¥0</span></div>
                            <div><span class="text-gray-500 block text-xs uppercase">損益合計</span><span class="font-bold text-lg" id="total-pl">¥0</span></div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/50" id="stock-list"></div>
                        <div class="p-2 bg-gray-800 border-t border-gray-700 text-center">
                             <button onclick="showImportModal()" class="text-xs text-blue-400 hover:text-blue-300"><i class="fa-solid fa-plus mr-1"></i> Geminiの結果を追加で取り込む</button>
                         </div>
                    </div>
                </div>

                <!-- 3. Links View -->
                <div id="view-links" class="absolute inset-0 flex flex-col hidden overflow-hidden">
                    <div class="p-4 border-b border-gray-700 bg-gray-800 flex justify-end">
                        <button onclick="addNewLinkRow()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-colors"><i class="fa-solid fa-plus"></i> リンクを追加</button>
                    </div>
                    <div id="links-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 translate-y-20 opacity-0 transition-all duration-300 z-50 bg-gray-800 border border-emerald-500/50 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-emerald-500"></i>
        <span id="toastMsg">Saved</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ↓↓↓ ここをあなたのFirebaseConfigに書き換える ↓↓↓
        const firebaseConfig = {
            apiKey: "AIzaSyDcvic5djCvqY0S1sf8ubefGBw4xLUpc58",
  authDomain: "gemini-portfolio-app.firebaseapp.com",
  projectId: "gemini-portfolio-app",
  storageBucket: "gemini-portfolio-app.firebasestorage.app",
  messagingSenderId: "118037184309",
  appId: "1:118037184309:web:82c694063b880aef68567c",
  measurementId: "G-14R42BY9B9"
        };
        // ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
        // ==========================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        // Expose functions to global scope for HTML onclick attributes
        window.login = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                alert("ログインに失敗しました: " + error.message);
            }
        };

        window.logout = () => {
            signOut(auth);
        };

        // UI Binding for login button
        document.getElementById('google-login-btn').addEventListener('click', window.login);

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('user-photo').classList.remove('hidden');
                
                // Load data from Cloud
                await loadDataFromCloud();
                
            } else {
                currentUser = null;
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('user-photo').classList.add('hidden');
                // Clear UI
                window.items = [];
                window.renderList();
            }
        });

        // --- Data Logic (Cloud Wrapper) ---
        // We use a global variable 'items' to keep app logic similar to previous version
        // But we sync this 'items' with Firestore document: users/{uid}/appData/v1
        
        window.items = [];
        let isSyncing = false;

        async function loadDataFromCloud() {
            if (!currentUser) return;
            setSyncStatus('Loading...');
            
            try {
                const docRef = doc(db, "users", currentUser.uid, "appData", "v1");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    window.items = JSON.parse(docSnap.data().json);
                    console.log("Data loaded from cloud");
                } else {
                    console.log("No cloud data found. Using empty or migrating local?");
                    // Optional: Check local storage for migration
                    const localData = localStorage.getItem('gemini_portfolio_manager_v3');
                    if (localData) {
                        if(confirm('ローカルに保存されたデータが見つかりました。これをクラウドに移行しますか？')){
                            window.items = JSON.parse(localData);
                            await saveDataToCloud(); // Save immediately
                        }
                    }
                    if (window.items.length === 0) {
                        window.createNewPrompt(); // Init default
                    }
                }
                window.renderAppInitialState();
            } catch (e) {
                console.error("Error loading data:", e);
                alert("データの読み込みに失敗しました。");
            } finally {
                setSyncStatus('Synced');
            }
        }

        window.saveDataToCloud = async () => {
            if (!currentUser) return;
            if (isSyncing) return;
            
            isSyncing = true;
            setSyncStatus('Saving...');
            
            try {
                const dataStr = JSON.stringify(window.items);
                const docRef = doc(db, "users", currentUser.uid, "appData", "v1");
                
                await setDoc(docRef, { 
                    json: dataStr,
                    updatedAt: new Date().toISOString()
                });
                
                setSyncStatus('Synced');
                window.showToast('Cloud Saved');
            } catch (e) {
                console.error("Error saving data:", e);
                setSyncStatus('Error');
            } finally {
                isSyncing = false;
            }
        };

        function setSyncStatus(status) {
            const el = document.getElementById('sync-status');
            if (status === 'Synced') {
                el.innerHTML = '<i class="fa-solid fa-check text-emerald-500"></i> Cloud Synced';
            } else if (status === 'Saving...') {
                el.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i> Saving...';
            } else if (status === 'Loading...') {
                el.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-gray-500"></i> Loading...';
            } else {
                 el.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i> ' + status;
            }
        }

        // --- Expose App Logic ---
        // The original app logic needs to call saveDataToCloud instead of saveToStorage
        // We override the saveToStorage function in the global scope below.
        
        // Load initial App Logic scripts after modules are ready
        const script = document.createElement('script');
        script.textContent = appLogicCode;
        document.body.appendChild(script);

    </script>

    <script>
        // --- Core Application Logic (Adapted for Cloud) ---
        // This runs in global scope but calls window.saveDataToCloud defined in module
        
        const DEFAULT_PROMPT = `# Role: Senior Deep Value Analyst (Japan Equity Specialist)
## Task Definition
ユーザーから提供された日本株銘柄リストに対し、清原達郎氏の投資哲学に基づく分析を実行せよ。

## Output Format
以下のMarkdownテーブル形式で出力すること:
| 順位 | コード | 銘柄名 | 現在株価 | 目標株価 | ...
`;
        let currentTab = 'prompt';
        let currentId = null;

        // Called after data load
        window.renderAppInitialState = () => {
            if (window.items.length === 0) {
                 createNewPrompt();
            } else {
                 // Check if links exist
                 let linkItem = window.items.find(i => i.type === 'links');
                 if (!linkItem) ensureAndSelectLinks(); // Ensure logic

                 const first = window.items.find(i => i.type === 'prompt') || window.items[0];
                 if(first) {
                     currentTab = first.type;
                     updateTabUI();
                     selectItem(first.id);
                 }
            }
            renderList();
        };

        // Replaces local storage save
        function saveToStorage() {
             if (window.saveDataToCloud) {
                 window.saveDataToCloud();
             }
        }

        function switchTab(tab) {
            currentTab = tab;
            currentId = null;
            updateTabUI();

            const sidebarContent = document.getElementById('sidebar-content');
            const sidebarLinksMsg = document.getElementById('sidebar-links-msg');
            const deleteBtn = document.getElementById('headerDeleteBtn');

            if (tab === 'links') {
                sidebarContent.classList.add('hidden');
                sidebarLinksMsg.classList.remove('hidden');
                deleteBtn.classList.add('hidden');
                ensureAndSelectLinks();
            } else {
                sidebarContent.classList.remove('hidden');
                sidebarLinksMsg.classList.add('hidden');
                deleteBtn.classList.remove('hidden');
                
                document.getElementById('inputTitle').value = '';
                document.getElementById('view-prompt').classList.add('hidden');
                document.getElementById('view-portfolio').classList.add('hidden');
                document.getElementById('view-links').classList.add('hidden');
                
                renderList();
            }
        }

        function ensureAndSelectLinks() {
            let linkItem = window.items.find(i => i.type === 'links');
            if (!linkItem) {
                linkItem = {
                    id: 'global_links_item_' + Date.now(), 
                    type: 'links',
                    title: '参考リンク集',
                    linkItems: [
                        { title: '01_四季報オンライン', url: 'https://shikiho.toyokeizai.net/' },
                        { title: '02_Yahoo!ファイナンス', url: 'https://finance.yahoo.co.jp/' }
                    ],
                    updatedAt: new Date().toISOString()
                };
                window.items.push(linkItem);
                saveToStorage();
            }
            selectItem(linkItem.id);
        }

        function updateTabUI() {
            ['prompt', 'portfolio', 'links'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (currentTab === t) {
                    btn.className = 'flex-1 py-3 text-xs md:text-sm font-bold transition-colors tab-active';
                } else {
                    btn.className = 'flex-1 py-3 text-xs md:text-sm font-bold transition-colors tab-inactive';
                }
            });
        }

        function renderList() {
            if (currentTab === 'links') return;
            const container = document.getElementById('itemList');
            container.innerHTML = '';
            
            const filtered = window.items.filter(i => i.type === currentTab)
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            filtered.forEach(item => {
                const isSelected = item.id === currentId;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer border transition-all mb-1 ${
                    isSelected ? 'bg-gray-700 border-gray-600' : 'hover:bg-gray-800 border-transparent'
                }`;
                div.onclick = () => selectItem(item.id);

                let icon = '';
                let colorClass = '';
                if (currentTab === 'prompt') { icon = '<i class="fa-solid fa-file-code"></i>'; colorClass = 'text-blue-400'; }
                else if (currentTab === 'portfolio') { icon = '<i class="fa-solid fa-chart-pie"></i>'; colorClass = 'text-emerald-400'; }

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="${colorClass} opacity-80">${icon}</div>
                        <div class="min-w-0">
                            <h4 class="text-sm font-bold truncate ${isSelected?'text-white':'text-gray-300'}">${item.title}</h4>
                            <p class="text-xs text-gray-500">${new Date(item.updatedAt).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectItem(id) {
            currentId = id;
            const item = window.items.find(i => i.id === id);
            if (!item) return;

            document.getElementById('inputTitle').value = item.title;
            document.getElementById('lastUpdated').textContent = `Updated: ${new Date(item.updatedAt).toLocaleString()}`;
            
            renderList();

            document.getElementById('view-prompt').classList.add('hidden');
            document.getElementById('view-portfolio').classList.add('hidden');
            document.getElementById('view-links').classList.add('hidden');

            if (item.type === 'prompt') {
                document.getElementById('view-prompt').classList.remove('hidden');
                document.getElementById('inputContent').value = item.content || '';
            } else if (item.type === 'portfolio') {
                document.getElementById('view-portfolio').classList.remove('hidden');
                renderPortfolio(item);
            } else if (item.type === 'links') {
                document.getElementById('view-links').classList.remove('hidden');
                renderLinks(item);
            }
        }

        function createNew() {
            if (currentTab === 'prompt') createNewPrompt();
            else if (currentTab === 'portfolio') createNewPortfolio();
        }

        function createNewPrompt() {
            const newItem = {
                id: Date.now().toString(),
                type: 'prompt',
                title: '新規プロンプト',
                content: DEFAULT_PROMPT,
                updatedAt: new Date().toISOString()
            };
            window.items.unshift(newItem);
            saveAndSelect(newItem);
        }

        function createNewPortfolio() {
            const newItem = {
                id: Date.now().toString(),
                type: 'portfolio',
                title: '新規ポートフォリオ',
                stocks: [],
                updatedAt: new Date().toISOString()
            };
            window.items.unshift(newItem);
            saveAndSelect(newItem);
        }
        
        function saveAndSelect(item) {
            saveToStorage();
            selectItem(item.id);
            renderList();
        }

        function saveCurrentItem() {
            if (!currentId) return;
            const item = window.items.find(i => i.id === currentId);
            
            item.title = document.getElementById('inputTitle').value;
            item.updatedAt = new Date().toISOString();

            if (item.type === 'prompt') {
                item.content = document.getElementById('inputContent').value;
            }

            if (item.type !== 'links') {
                window.items = window.items.filter(i => i.id !== currentId);
                window.items.unshift(item);
            }
            
            saveToStorage();
            if (currentTab !== 'links') renderList();
            // Toast shown by cloud wrapper
        }

        function deleteCurrentItem() {
            if (!currentId || !confirm('削除しますか？')) return;
            const item = window.items.find(i => i.id === currentId);
            if (item && item.type === 'links') return;

            window.items = window.items.filter(i => i.id !== currentId);
            saveToStorage();
            currentId = null;
            renderList();
            
            document.getElementById('inputTitle').value = '';
            document.getElementById('view-prompt').classList.add('hidden');
            document.getElementById('view-portfolio').classList.add('hidden');
            document.getElementById('view-links').classList.add('hidden');
        }

        // --- Links Logic ---
        function renderLinks(item) {
            const container = document.getElementById('links-list');
            container.innerHTML = '';
            
            if (!item.linkItems) item.linkItems = [];

            item.linkItems.sort((a, b) => {
                const tA = (a.title || '').toString().toLowerCase();
                const tB = (b.title || '').toString().toLowerCase();
                return tA.localeCompare(tB, 'ja');
            });

            if (item.linkItems.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center p-8">リンクがありません。<br>"リンクを追加"ボタンを押してください。</div>';
                return;
            }

            item.linkItems.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg flex gap-3 items-center group';
                div.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <input type="text" value="${link.title || ''}" onchange="updateLinkItem(${index}, 'title', this.value)" class="w-full bg-transparent text-white font-bold placeholder-gray-600 focus:outline-none focus:border-b border-gray-600" placeholder="サイト名 (例: 01_Yahoo)">
                        <input type="text" value="${link.url || ''}" onchange="updateLinkItem(${index}, 'url', this.value)" class="w-full bg-transparent text-sm text-blue-300 font-mono placeholder-gray-600 focus:outline-none focus:border-b border-gray-600" placeholder="https://...">
                    </div>
                    <div class="flex gap-2">
                        <a href="${link.url}" target="_blank" class="bg-indigo-600 hover:bg-indigo-500 text-white w-10 h-10 rounded-full flex items-center justify-center transition-colors shadow-lg" title="開く">
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                        <button onclick="removeLinkItem(${index})" class="text-gray-600 hover:text-red-400 w-8 h-8 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addNewLinkRow() {
            const item = window.items.find(i => i.id === currentId);
            if (!item.linkItems) item.linkItems = [];
            item.linkItems.push({ title: '', url: '' });
            saveToStorage();
            renderLinks(item);
        }

        function updateLinkItem(index, field, value) {
            const item = window.items.find(i => i.id === currentId);
            item.linkItems[index][field] = value;
            saveToStorage();
        }

        function removeLinkItem(index) {
            if (!confirm('リンクを削除しますか？')) return;
            const item = window.items.find(i => i.id === currentId);
            item.linkItems.splice(index, 1);
            saveToStorage();
            renderLinks(item);
        }

        // --- Portfolio Logic ---
        function generateLinkButtons(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s\n]+)/g;
            const urls = text.match(urlRegex);
            if (!urls) return '';

            return urls.map(url => {
                let label = 'Link';
                try {
                    const urlObj = new URL(url);
                    label = urlObj.hostname.replace('www.', '');
                } catch(e) {}
                return `
                    <a href="${url}" target="_blank" class="inline-flex items-center gap-1 bg-gray-700 hover:bg-gray-600 border border-gray-600 text-blue-300 text-xs px-2 py-1 rounded transition-colors" title="${url}">
                        <i class="fa-solid fa-up-right-from-square text-[10px]"></i> ${label}
                    </a>
                `;
            }).join('');
        }

        function renderPortfolio(item) {
            const dashboard = document.getElementById('portfolio-dashboard');
            const importer = document.getElementById('portfolio-importer');
            const listContainer = document.getElementById('stock-list');

            if (!item.stocks || item.stocks.length === 0) {
                dashboard.classList.add('hidden');
                importer.classList.remove('hidden');
                document.getElementById('importText').value = '';
                return;
            }

            dashboard.classList.remove('hidden');
            importer.classList.add('hidden');
            listContainer.innerHTML = '';

            let totalInvest = 0;
            let totalVal = 0;

            item.stocks.forEach((stock, index) => {
                const currentPrice = parseFloat(stock.currentPrice) || 0;
                const buyPrice = parseFloat(stock.buyPrice) || 0;
                const quantity = parseFloat(stock.quantity) || 0;
                const sellPrice = parseFloat(stock.sellPrice) || 0;

                const isSold = sellPrice > 0;
                const investment = buyPrice * quantity;
                
                let currentValue = 0;
                let pl = 0;
                let plClass = 'text-gray-400';

                if (quantity > 0) {
                    if (isSold) {
                        currentValue = sellPrice * quantity;
                    } else {
                        currentValue = currentPrice * quantity;
                    }
                    pl = currentValue - investment;
                    plClass = pl >= 0 ? 'text-emerald-400' : 'text-red-400';
                    totalInvest += investment;
                    totalVal += currentValue;
                }

                const linkButtons = generateLinkButtons(stock.links);

                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg p-4 border ${isSold ? 'border-gray-700 opacity-80' : 'border-gray-600'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="bg-gray-700 text-xs px-2 py-0.5 rounded font-mono">${stock.code}</span>
                                <h3 class="font-bold text-lg text-white">${stock.name}</h3>
                                ${isSold ? '<span class="bg-blue-900 text-blue-200 text-xs px-2 py-0.5 rounded">売却済</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                現在値: <span class="font-mono text-white">${currentPrice.toLocaleString()}</span> / 目標: <span class="font-mono text-emerald-300">${stock.targetPrice}</span>
                            </div>
                        </div>
                        <button onclick="removeStock(${index})" class="text-gray-600 hover:text-red-400 transition-colors">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase block">購入単価</label>
                            <input type="number" value="${stock.buyPrice || ''}" onchange="updateStock(${index}, 'buyPrice', this.value)" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm font-mono focus:border-blue-500 outline-none text-right" placeholder="0">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase block">保有株数</label>
                            <input type="number" value="${stock.quantity || ''}" onchange="updateStock(${index}, 'quantity', this.value)" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm font-mono focus:border-blue-500 outline-none text-right" placeholder="0">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase block">売却単価 (任意)</label>
                            <input type="number" value="${stock.sellPrice || ''}" onchange="updateStock(${index}, 'sellPrice', this.value)" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm font-mono focus:border-blue-500 outline-none text-right text-yellow-300" placeholder="-">
                        </div>
                    </div>

                    ${quantity > 0 ? `
                    <div class="flex justify-between items-center bg-gray-900/50 p-2 rounded text-sm mb-3">
                        <span class="text-xs text-gray-500">損益 (P/L)</span>
                        <span class="font-bold font-mono ${plClass}">
                            ${pl > 0 ? '+' : ''}${pl.toLocaleString()}
                        </span>
                    </div>
                    ` : ''}

                    <details class="mt-2 border-t border-gray-700 pt-2 group">
                        <summary class="cursor-pointer text-xs text-blue-400 hover:text-blue-300 flex items-center gap-2 select-none focus:outline-none">
                            <i class="fa-solid fa-chevron-right text-[10px] group-open:rotate-90 transition-transform"></i>
                            <i class="fa-solid fa-pen-to-square"></i> メモ・関連リンク
                        </summary>
                        <div class="mt-3 space-y-3 pl-1">
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase block mb-1">メモ (Note)</label>
                                <textarea onchange="updateStock(${index}, 'note', this.value)" class="w-full bg-gray-900/80 border border-gray-700 rounded p-2 text-sm text-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors" rows="2" placeholder="メモを入力...">${stock.note || ''}</textarea>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase block mb-1">関連リンク (改行区切り)</label>
                                <textarea onchange="updateStock(${index}, 'links', this.value)" class="w-full bg-gray-900/80 border border-gray-700 rounded p-2 text-sm text-gray-300 font-mono focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors" rows="2" placeholder="https://...">${stock.links || ''}</textarea>
                                ${linkButtons ? `<div class="mt-2 flex flex-wrap gap-2">${linkButtons}</div>` : ''}
                            </div>
                        </div>
                    </details>
                `;
                listContainer.appendChild(card);
            });

            const totalPl = totalVal - totalInvest;
            document.getElementById('total-investment').textContent = `¥${totalInvest.toLocaleString()}`;
            document.getElementById('total-value').textContent = `¥${totalVal.toLocaleString()}`;
            
            const plEl = document.getElementById('total-pl');
            plEl.textContent = `¥${totalPl.toLocaleString()}`;
            plEl.className = `font-bold text-lg ${totalPl >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
        }

        function showImportModal() {
            document.getElementById('portfolio-dashboard').classList.add('hidden');
            document.getElementById('portfolio-importer').classList.remove('hidden');
        }

        function hideImportModal() {
            // If stocks exist, go back to dashboard, else stay (or could go empty)
            const item = window.items.find(i => i.id === currentId);
            if (item && item.stocks && item.stocks.length > 0) {
                 document.getElementById('portfolio-importer').classList.add('hidden');
                 document.getElementById('portfolio-dashboard').classList.remove('hidden');
            }
        }

        function importPortfolio() {
            const text = document.getElementById('importText').value;
            if (!text.trim()) return;

            const lines = text.split('\n').filter(line => line.trim().startsWith('|'));
            let codeIdx = 1, nameIdx = 2, priceIdx = 3, targetIdx = 4;
            const dataRows = lines.filter(line => !line.includes('---') && !line.includes('順位'));

            const newStocks = dataRows.map(row => {
                const cols = row.split('|').map(c => c.trim()).filter(c => c !== '');
                if (cols.length < 3) return null;

                const priceStr = cols[priceIdx-1] || '0';
                const priceVal = parseFloat(priceStr.replace(/[^0-9.]/g, ''));

                return {
                    code: cols[codeIdx-1] || '????',
                    name: cols[nameIdx-1] || 'Unknown',
                    currentPrice: priceVal,
                    targetPrice: cols[targetIdx-1] || '-',
                    buyPrice: 0,
                    quantity: 0,
                    sellPrice: 0,
                    note: '',
                    links: ''
                };
            }).filter(s => s !== null);

            if (newStocks.length === 0) {
                alert('銘柄を検出できませんでした。');
                return;
            }

            const item = window.items.find(i => i.id === currentId);
            if (!item.stocks) item.stocks = [];
            item.stocks = [...item.stocks, ...newStocks];
            
            saveToStorage();
            renderPortfolio(item);
        }

        function updateStock(index, field, value) {
            const item = window.items.find(i => i.id === currentId);
            item.stocks[index][field] = value;
            saveToStorage();
            if (field === 'note' || field === 'links') {
                renderPortfolio(item); 
            } else {
                renderPortfolio(item);
            }
        }

        function removeStock(index) {
            if(!confirm('削除しますか？')) return;
            const item = window.items.find(i => i.id === currentId);
            item.stocks.splice(index, 1);
            saveToStorage();
            renderPortfolio(item);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2000);
        }

        function copyContent() {
            navigator.clipboard.writeText(document.getElementById('inputContent').value)
                .then(() => showToast('Copied'));
        }
        
        // This is a placeholder for the logic code that is loaded dynamically
        const appLogicCode = `
            // Logic is already embedded above for simplicity in this single-file solution
            console.log("App Logic Loaded");
        `;
    </script>
</body>
</html>
